# Проект: Веб-приложение для шифрования текста (Шифр Плейфера)

## 1. Обзор проекта

Данный проект представляет собой клиент-серверное веб-приложение, реализующее шифрование и дешифрование текста с использованием классического шифра Плейфера. Приложение позволяет пользователям регистрироваться, управлять своими текстовыми записями и шифровать/дешифровать сообщения с помощью выбранного ключа.

## 2. Основные возможности

*   **Аутентификация:**
    *   Регистрация новых пользователей.
    *   Вход существующих пользователей.
    *   Изменение пароля (с обновлением токена аутентификации).
    *   Система аутентификации на основе токенов.
*   **Управление текстами:**
    *   Добавление новых текстовых записей.
    *   Просмотр списка всех текстов пользователя.
    *   Просмотр содержимого конкретного текста.
    *   Редактирование существующих текстов.
    *   Удаление текстов.
*   **Шифрование:**
    *   Шифрование введенного текста с помощью шифра Плейфера и заданного ключа.
    *   Дешифрование зашифрованного текста с помощью шифра Плейфера и соответствующего ключа.
    *   Поддержка только английского алфавита для шифрования.
*   **История запросов:**
    *   Автоматическое логирование запросов пользователя к API (тип запроса, эндпоинт).
    *   Просмотр истории запросов.
    *   Очистка истории запросов.
*   **Хранение данных:**
    *   Данные пользователей (логин, хеш пароля, токен), тексты и история хранятся в файле `server/database.json`.
    *   Пароли хешируются с использованием SHA-256.

## 3. Структура проекта

```
/
├── client/               # Клиентская часть (веб-интерфейс)
│   ├── index.html        # Основная HTML страница
│   ├── style.css         # Стили для интерфейса
│   ├── script.js         # Логика клиентской части (взаимодействие с API)
│   └── main.py           # Консольный клиент (альтернативный)
├── server/               # Серверная часть (API)
│   ├── main.py           # Основной файл FastAPI приложения (эндпоинты)
│   ├── auth.py           # Логика аутентификации, работа с БД (JSON)
│   ├── cipher.py         # Реализация шифра Плейфера
│   ├── schemas.py        # Модели данных Pydantic (для FastAPI)
│   └── database.json     # Файл для хранения данных (пользователи, тексты, история)
├── tests/                # Тесты
│   └── test_api.py       # API тесты (unittest)
├── .gitignore            # Файлы, игнорируемые Git
├── requirements.txt      # Зависимости Python
└── README.md             # Этот файл документации
```

## 4. Технологический стек

*   **Бэкенд:** Python, FastAPI, Uvicorn
*   **Фронтенд:** HTML, CSS, JavaScript (без фреймворков)
*   **Хранение данных:** JSON файл
*   **Шифрование:** Реализация шифра Плейфера на Python (с использованием NumPy)
*   **Тестирование:** `unittest` (стандартная библиотека Python), `requests`

## 5. Установка и запуск

**Шаг 1: Клонирование репозитория (если применимо)**

```bash
git clone <url-репозитория>
cd <папка-проекта>
```

**Шаг 2: Установка зависимостей**

Убедитесь, что у вас установлен Python 3.x и pip. Выполните команду в корневой папке проекта:

```bash
pip install -r requirements.txt
```

**Шаг 3: Запуск сервера**

Перейдите в корневую папку проекта и запустите сервер FastAPI:

```bash
python server/main.py
```

Сервер будет доступен по адресу `http://localhost:8000`. Он будет автоматически перезагружаться при изменениях в коде благодаря флагу `reload=True`.

**Шаг 4: Доступ к клиенту**

Откройте файл `client/index.html` в вашем веб-браузере.

## 6. Запуск тестов

Для запуска тестов убедитесь, что сервер (`server/main.py`) запущен. Затем выполните одну из следующих команд в корневой папке проекта:

*   Запуск конкретного файла с тестами:
    ```bash
    python -m unittest tests/test_api.py
    ```
*   Автоматическое обнаружение и запуск всех тестов в папке `tests`:
    ```bash
    python -m unittest discover tests
    ```

## 7. Документация API

Сервер предоставляет следующие эндпоинты:

| Метод  | Путь                  | Описание                      | Параметры запроса                             | Тело запроса (JSON)                | Ответ (Успех)                      | Ответ (Ошибка)                  |
| :----- | :-------------------- | :---------------------------- | :-------------------------------------------- | :--------------------------------- | :--------------------------------- | :------------------------------ |
| POST   | `/register`           | Регистрация пользователя      | -                                             | `UserBase` (username, password)  | `TokenResponse` (id, token, msg) | 400 (User exists)             |
| POST   | `/login`              | Вход пользователя             | -                                             | `UserBase` (username, password)  | `TokenResponse` (id, token, msg) | 400 (Not found, Wrong pass) |
| PATCH  | `/change-password`    | Смена пароля                  | `old_password`, `new_password`, `token`       | -                                  | `TokenResponse` (id, token, msg) | 400/401 (Wrong pass, Bad token) |
| GET    | `/all-users`          | Получить список username      | -                                             | -                                  | `List[str]` (usernames)          | -                               |
| GET    | `/history`            | Получить историю запросов     | `token`                                       | -                                  | `List[RequestHistory]`           | 401 (Bad token)               |
| DELETE | `/history`            | Удалить историю запросов      | `token`                                       | -                                  | `{"message": "..."}`             | 401 (Bad token)               |
| POST   | `/encrypt`            | Зашифровать текст             | `token`                                       | `CipherRequest` (text, key)      | `CipherResponse` (result)        | 400/401 (Bad input, Bad token)  |
| POST   | `/decrypt`            | Расшифровать текст            | `token`                                       | `CipherRequest` (text, key)      | `CipherResponse` (result)        | 400/401 (Bad input, Bad token)  |
| POST   | `/texts`              | Добавить текст                | `token`                                       | `TextRequest` (text)             | `TextResponse` (id, text, time)  | 400/401 (Save fail, Bad token)  |
| GET    | `/texts`              | Получить все тексты           | `token`                                       | -                                  | `List[TextResponse]`             | 401 (Bad token)               |
| GET    | `/texts/{text_id}`    | Получить текст по ID          | `token`                                       | -                                  | `TextResponse`                   | 401/404 (Bad token, Not found)  |
| PATCH  | `/texts/{text_id}`    | Изменить текст по ID          | `token`                                       | `TextRequest` (text)             | `TextResponse`                   | 401/404 (Bad token, Not found)  |
| DELETE | `/texts/{text_id}`    | Удалить текст по ID           | `token`                                       | -                                  | `{"message": "..."}`             | 401/404 (Bad token, Not found)  |

**Модели данных (см. `server/schemas.py`):**

*   `UserBase`: `{ "username": "user", "password": "pwd" }`
*   `TokenResponse`: `{ "id": 123, "token": "xyz", "message": "Success" }`
*   `RequestHistory`: `{ "timestamp": "iso_date", "request_type": "GET", "endpoint": "/history" }`
*   `CipherRequest`: `{ "text": "hello", "key": "secret" }`
*   `CipherResponse`: `{ "result": "ifmmp" }`
*   `TextRequest`: `{ "text": "My note" }`
*   `TextResponse`: `{ "id": 1, "text": "My note", "timestamp": "iso_date" }`

**Аутентификация:** Большинство эндпоинтов требуют передачи валидного токена пользователя в параметрах запроса (`?token=...`). Токен выдается при регистрации или входе.

## 8. Реализация шифра Плейфера (`server/cipher.py`)

*   **Подготовка ключа (`generate_key_table`):**
    *   Ключ приводится к нижнему регистру, удаляются пробелы и дубликаты букв.
    *   Буква 'j' заменяется на 'i'.
    *   Формируется матрица 5x5, сначала из уникальных букв ключа, затем из оставшихся букв английского алфавита.
*   **Подготовка текста (`prepare_text`):**
    *   Текст проверяется на наличие только английских букв и пробелов. При наличии других символов выбрасывается ошибка `ValueError`.
    *   Текст приводится к нижнему регистру, удаляются пробелы, 'j' заменяется на 'i'.
    *   Между одинаковыми буквами в биграмме вставляется 'x' (например, "hello" -> "helxlo").
    *   Если длина текста нечетная, в конец добавляется 'z'.
*   **Шифрование/Дешифрование (`encrypt`, `decrypt`):**
    *   Текст обрабатывается попарно (биграммы).
    *   Применяются стандартные правила шифра Плейфера для букв в одной строке, одном столбце или образующих прямоугольник в ключевой таблице.
    *   Дешифрование выполняет обратные операции.
    *   **Важно:** Функция дешифрования не удаляет автоматически символы ('x', 'z'), добавленные на этапе подготовки текста.

## 9. Аутентификация и безопасность

*   **Хранение паролей:** Пароли пользователей не хранятся в открытом виде. Вместо этого используется хеш SHA-256 от пароля (`server/auth.py` -> `get_password_hash`).
*   **Токены:** После успешной регистрации или входа пользователю выдается случайный токен (`secrets.token_urlsafe`). Этот токен используется для аутентификации последующих запросов. При смене пароля генерируется новый токен.
*   **Проверка токена:** Большинство API-эндпоинтов проверяют наличие и валидность токена перед выполнением операции.
*   **CORS:** Настроены заголовки CORS (`fastapi.middleware.cors`) для разрешения запросов с любого источника (`allow_origins=["*"]`), что упрощает разработку клиентской части. В реальном приложении следует ограничить список разрешенных источников. 